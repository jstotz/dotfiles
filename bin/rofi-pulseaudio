#!/bin/bash

# choose pulseaudio sink via rofi
# changes default sink and moves all streams to that sink

set -euo pipefail

format_sinks() {
  cut -f 2,4 | sed 's/\t/: /' | sed 's/\s\+/ /g'
}

current_sink=$(ponymix defaults --short | grep '^sink\s' | format_sinks)

echo "Current default sink ${current_sink}"

new_sink=$(
  ponymix list -t sink --short |
    format_sinks |
    sed "/^${current_sink}$/ s/$/ ***/" |
    rofi -dmenu -p 'PulseAudio Sink' --no-custom
)

new_sink_id=$(echo "$new_sink" | cut -d ':' -f 1)

echo "New default sink ${new_sink}"

ponymix set-default -d $new_sink_id

ponymix list -t sink-input --short | while read -r line; do
  echo "Moving input $(echo "${line}" | cut -f 3) to sink ${new_sink}"
  input_id=$(echo "${line}" | cut -f 2)
  ponymix -t sink-input -d "${input_id}" move "${new_sink_id}"
done
